---
import { getCollection } from "astro:content";
import Layout from "~/layouts/PageLayout.astro";
import { languages } from "~/i18n";
import fs from "node:fs";
import path from "node:path";
// Importujemy Twój komponent komentarzy
import Comments from "~/components/blog/Comments.astro";

// Generowanie ścieżek dla wszystkich postów i języków
export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return Object.keys(languages).flatMap((lang) =>
    posts.map((post) => ({
      params: { lang, slug: post.slug },
      props: { post, lang },
    })),
  );
}

const { post, lang } = Astro.props;
const { Content } = await post.render();

// Funkcja pomocnicza do obrazków
function getPostImage(postData, slug) {
  if (postData.heroImage) return postData.heroImage;
  try {
    const extensions = ["jpg", "png", "webp", "jpeg"];
    const publicDir = path.join(process.cwd(), "public");
    const blogImagesDir = path.join(publicDir, "assets", "images", "blog");
    for (const ext of extensions) {
      const filename = `${slug}.${ext}`;
      if (fs.existsSync(path.join(blogImagesDir, filename))) {
        return `/assets/images/blog/${filename}`;
      }
    }
  } catch (e) {}
  return "/assets/images/blog/default.png";
}

const heroImage = getPostImage(post.data, post.slug);
const metadata = {
  title: `${post.data.title} - KGR33N`,
  description: post.data.description,
  image: heroImage,
};
---

<Layout metadata={metadata}>
  <article class="px-4 py-16 mx-auto max-w-4xl min-h-screen">
    <header class="mb-8 text-center">
      {
        heroImage && (
          <img
            src={heroImage}
            alt={post.data.title}
            class="mx-auto rounded-lg shadow-lg mb-8 max-h-[400px] w-full object-cover"
          />
        )
      }
      <h1
        class="text-4xl md:text-5xl font-bold leading-tight mb-4 text-gray-900 dark:text-gray-100"
      >
        {post.data.title}
      </h1>
      <div class="text-sm text-gray-500 dark:text-gray-400">
        <time datetime={post.data.pubDate.toISOString()}>
          {
            post.data.pubDate.toLocaleDateString(
              lang === "pl" ? "pl-PL" : "en-US",
              {
                year: "numeric",
                month: "long",
                day: "numeric",
              },
            )
          }
        </time>
        <span class="mx-2">•</span>
        <span>{lang.toUpperCase()}</span>
      </div>
    </header>

    <div class="prose prose-lg dark:prose-invert max-w-none mb-12">
      <Content />
    </div>

    <hr class="border-gray-200 dark:border-gray-700 my-12" />
    <Comments post_slug={post.slug} lang={lang} />
  </article>
</Layout>
