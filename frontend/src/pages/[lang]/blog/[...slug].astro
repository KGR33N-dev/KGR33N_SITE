---
import { getCollection } from "astro:content";
import Layout from "~/layouts/PageLayout.astro";
import { languages } from "~/i18n";
import fs from "node:fs";
import path from "node:path";
// Importujemy Twój komponent komentarzy
import Comments from "~/components/blog/Comments.astro";

// Generowanie ścieżek dla wszystkich postów z odpowiednich katalogów językowych
export async function getStaticPaths() {
  const allPosts = await getCollection("blog");

  // Grupujemy posty według języka na podstawie ścieżki (en/xxx lub pl/xxx)
  const paths = [];

  for (const lang of Object.keys(languages)) {
    // Filtrujemy posty dla danego języka
    const langPosts = allPosts.filter((post) => {
      // Sprawdzamy czy ID posta zaczyna się od en/ lub pl/
      return post.id.startsWith(`${lang}/`);
    });

    for (const post of langPosts) {
      // Slug bez prefiksu języka
      const slugWithoutLang = post.slug.replace(`${lang}/`, "");
      paths.push({
        params: { lang, slug: slugWithoutLang },
        props: { post, lang },
      });
    }
  }

  return paths;
}

const { post, lang } = Astro.props;
const { Content } = await post.render();

// Funkcja pomocnicza do obrazków
function getPostImage(postData, slug) {
  if (postData.heroImage) return postData.heroImage;
  if (postData.featured_image) return postData.featured_image;
  try {
    const extensions = ["jpg", "png", "webp", "jpeg"];
    const publicDir = path.join(process.cwd(), "public");
    const blogImagesDir = path.join(publicDir, "assets", "images", "blog");
    for (const ext of extensions) {
      const filename = `${slug}.${ext}`;
      if (fs.existsSync(path.join(blogImagesDir, filename))) {
        return `/assets/images/blog/${filename}`;
      }
    }
  } catch (e) {}
  return "/assets/images/blog/default.png";
}

// Slug bez prefiksu języka dla obrazka
const cleanSlug = post.data.slug || post.slug.replace(`${lang}/`, "");
const heroImage = getPostImage(post.data, cleanSlug);
const metadata = {
  title: `${post.data.title} - KGR33N`,
  description: post.data.description,
  image: heroImage,
};
---

<Layout metadata={metadata}>
  <article class="px-4 py-16 mx-auto max-w-4xl min-h-screen">
    <header class="mb-8 text-center">
      {
        heroImage && (
          <img
            src={heroImage}
            alt={post.data.title}
            class="mx-auto rounded-lg shadow-lg mb-8 max-h-[400px] w-full object-cover"
          />
        )
      }
      <h1
        class="text-4xl md:text-5xl font-bold leading-tight mb-4 text-gray-900 dark:text-gray-100"
      >
        {post.data.title}
      </h1>
      <div class="text-sm text-gray-500 dark:text-gray-400">
        <time datetime={post.data.pubDate.toISOString()}>
          {
            post.data.pubDate.toLocaleDateString(
              lang === "pl" ? "pl-PL" : "en-US",
              {
                year: "numeric",
                month: "long",
                day: "numeric",
              },
            )
          }
        </time>
        <span class="mx-2">•</span>
        <span>{lang.toUpperCase()}</span>
      </div>
    </header>

    <div class="prose prose-lg dark:prose-invert max-w-none mb-12">
      <Content />
    </div>

    <hr class="border-gray-200 dark:border-gray-700 my-12" />
    <Comments post_slug={cleanSlug} lang={lang} />
  </article>
</Layout>
