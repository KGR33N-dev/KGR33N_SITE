---
export const prerender = true;

import Layout from "~/layouts/PageLayout.astro";
import Headline from "~/components/ui/Headline.astro";
import WidgetWrapper from "~/components/ui/WidgetWrapper.astro";
import { useTranslations } from "~/i18n/utils";
import { languages } from "~/i18n";

export function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({
    params: { lang },
  }));
}

const { lang } = Astro.params;
const t = useTranslations(lang as keyof typeof languages);

const metadata = {
  title: t("admin.dashboard"),
  description: t("admin.blogManagement"),
  robots: {
    index: false,
    follow: false,
  },
};
---

<!-- Import required modules in head for global availability -->
<script>
  import "~/config/api";
  import "~/utils/adminAuth";
</script>

<Layout metadata={metadata}>
  <WidgetWrapper
    id="admin-dashboard"
    containerClass="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8"
  >
    <!-- Main Dashboard Content -->
    <div id="dashboard-content">
      <!-- Header with title -->
      <div
        class="bg-white dark:bg-slate-900 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700 mb-8"
      >
        <div
          class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center"
        >
          <div>
            <Headline
              title={t("admin.dashboard")}
              subtitle={t("admin.welcome")}
              classes={{
                container: "",
                title: "text-2xl font-bold text-gray-900 dark:text-white",
                subtitle: "text-sm text-gray-600 dark:text-gray-400 mt-1",
              }}
            />
          </div>
        </div>
      </div>
      <!-- Statistics Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <!-- Users Card -->
        <div
          class="bg-white dark:bg-slate-900 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700 p-6"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600 dark:text-gray-400">
                {t("admin.totalUsers")}
              </p>
              <p
                id="stat-users"
                class="text-2xl font-bold text-gray-900 dark:text-white"
              >
                -
              </p>
              <p
                id="stat-users-new"
                class="text-xs text-green-600 dark:text-green-400 mt-1"
              >
                -
              </p>
            </div>
            <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-full">
              <svg
                class="w-6 h-6 text-blue-600 dark:text-blue-400"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                ></path>
              </svg>
            </div>
          </div>
        </div>

        <!-- Posts Card -->
        <div
          class="bg-white dark:bg-slate-900 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700 p-6"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600 dark:text-gray-400">
                {t("admin.totalPosts")}
              </p>
              <p
                id="stat-posts"
                class="text-2xl font-bold text-gray-900 dark:text-white"
              >
                -
              </p>
            </div>
            <div class="p-3 bg-purple-100 dark:bg-purple-900/30 rounded-full">
              <svg
                class="w-6 h-6 text-purple-600 dark:text-purple-400"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"
                ></path>
              </svg>
            </div>
          </div>
        </div>

        <!-- Comments Card -->
        <div
          class="bg-white dark:bg-slate-900 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700 p-6"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600 dark:text-gray-400">
                {t("admin.totalComments")}
              </p>
              <p
                id="stat-comments"
                class="text-2xl font-bold text-gray-900 dark:text-white"
              >
                -
              </p>
              <p
                id="stat-comments-new"
                class="text-xs text-green-600 dark:text-green-400 mt-1"
              >
                -
              </p>
            </div>
            <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-full">
              <svg
                class="w-6 h-6 text-green-600 dark:text-green-400"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                ></path>
              </svg>
            </div>
          </div>
        </div>

        <!-- Likes Card -->
        <div
          class="bg-white dark:bg-slate-900 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700 p-6"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600 dark:text-gray-400">
                {t("admin.totalReactions")}
              </p>
              <p
                id="stat-likes"
                class="text-2xl font-bold text-gray-900 dark:text-white"
              >
                -
              </p>
              <p
                id="stat-likes-new"
                class="text-xs text-green-600 dark:text-green-400 mt-1"
              >
                -
              </p>
            </div>
            <div class="p-3 bg-red-100 dark:bg-red-900/30 rounded-full">
              <svg
                class="w-6 h-6 text-red-600 dark:text-red-400"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
                ></path>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Users Section -->
      <div
        class="bg-white dark:bg-slate-900 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700 mb-8"
      >
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
            {t("admin.recentUsers")}
          </h3>
        </div>
        <div class="p-6">
          <div id="recent-users-list" class="space-y-3">
            <div class="flex items-center justify-center py-4">
              <div
                class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"
              >
              </div>
              <span class="ml-2 text-gray-600 dark:text-gray-400 text-sm"
                >{t("admin.loading")}</span
              >
            </div>
          </div>
        </div>
      </div>

      <!-- All Posts Management -->
      <div
        class="bg-white dark:bg-slate-900 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700 mb-8"
      >
        <div
          class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center"
        >
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
            {t("admin.allPosts")}
          </h3>
        </div>
        <div class="p-6">
          <div id="all-posts-list" class="space-y-4">
            <!-- All posts will be loaded here dynamically -->
            <div class="flex items-center justify-center py-8">
              <div
                class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"
              >
              </div>
              <span class="ml-2 text-gray-600 dark:text-gray-400"
                >{t("admin.loadingPosts")}</span
              >
            </div>
          </div>
          <!-- Pagination -->
          <div id="posts-pagination" class="mt-6 flex justify-center">
            <!-- Pagination will be added here -->
          </div>
        </div>
      </div>

      <!-- System Status -->
      <div
        class="bg-white dark:bg-slate-900 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700"
      >
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
            {t("admin.systemStatus")}
          </h3>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="flex items-center">
              <div
                id="api-status-icon"
                class="w-3 h-3 rounded-full bg-gray-400 mr-2"
              >
              </div>
              <span class="text-sm text-gray-600 dark:text-gray-400"
                >{t("admin.apiConnection")}:
              </span>
              <span id="api-status-text" class="text-sm font-medium ml-1"
                >{t("admin.checking")}</span
              >
            </div>
            <div class="flex items-center">
              <div
                id="auth-status-icon"
                class="w-3 h-3 rounded-full bg-green-500 mr-2"
              >
              </div>
              <span class="text-sm text-gray-600 dark:text-gray-400"
                >{t("admin.authentication")}:
              </span>
              <span
                id="auth-status-text"
                class="text-sm font-medium text-green-600 ml-1"
                >{t("admin.active")}</span
              >
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 rounded-full bg-blue-500 mr-2"></div>
              <span class="text-sm text-gray-600 dark:text-gray-400"
                >{t("admin.version")}:
              </span>
              <span class="text-sm font-medium text-blue-600 ml-1">v1.0.0</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- End of dashboard-content -->

    <!-- Access Denied Message (hidden by default) -->
    <div
      id="access-denied"
      class="hidden bg-red-100 dark:bg-red-900/20 border border-red-400 text-red-700 dark:text-red-400 px-6 py-4 rounded-lg text-center"
    >
      <h3 class="font-semibold text-lg mb-2">{t("admin.accessDenied")}</h3>
      <p class="mb-4">{t("admin.adminAccessRequired")}</p>
      <a
        href={`/${lang}/login`}
        class="inline-block px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200"
      >
        {t("admin.goToLogin")}
      </a>
    </div>
  </WidgetWrapper>
</Layout>

<script>
  import { initDashboardPage } from "~/scripts/auth/dashboardInit";

  // Initialize dashboard logic
  const lang = window.location.pathname.split("/")[1] || "en";

  // Use astro:page-load for View Transitions support, fallback to direct call
  document.addEventListener("astro:page-load", () => initDashboardPage(lang));
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () =>
      initDashboardPage(lang),
    );
  } else {
    initDashboardPage(lang);
  }
</script>
