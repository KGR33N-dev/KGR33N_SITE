---
export const prerender = true;

import Layout from "~/layouts/PageLayout.astro";
import Headline from "~/components/ui/Headline.astro";
import WidgetWrapper from "~/components/ui/WidgetWrapper.astro";
import { useTranslations } from "~/i18n/utils";
import { languages } from "~/i18n";

export function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({
    params: { lang },
  }));
}

const { lang } = Astro.params;
const t = useTranslations(lang as keyof typeof languages);

const metadata = {
  title: t("admin.dashboard"),
  description: t("admin.blogManagement"),
  robots: {
    index: false,
    follow: false,
  },
};
---

<!-- Import required modules in head for global availability -->
<script>
  import "~/config/api";
  import "~/utils/adminAuth";
</script>

<Layout metadata={metadata}>
  <WidgetWrapper
    id="admin-dashboard"
    containerClass="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8"
  >
    <!-- Main Dashboard Content -->
    <div id="dashboard-content">
      <!-- Header with title -->
      <div
        class="bg-white dark:bg-slate-900 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700 mb-8"
      >
        <div
          class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center"
        >
          <div>
            <Headline
              title={t("admin.dashboard")}
              subtitle={t("admin.welcome")}
              classes={{
                container: "",
                title: "text-2xl font-bold text-gray-900 dark:text-white",
                subtitle: "text-sm text-gray-600 dark:text-gray-400 mt-1",
              }}
            />
          </div>
        </div>
      </div>
      <!-- All Posts Management -->
      <div
        class="bg-white dark:bg-slate-900 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700 mb-8"
      >
        <div
          class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center"
        >
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
            {t("admin.allPosts")}
          </h3>
        </div>
        <div class="p-6">
          <div id="all-posts-list" class="space-y-4">
            <!-- All posts will be loaded here dynamically -->
            <div class="flex items-center justify-center py-8">
              <div
                class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"
              >
              </div>
              <span class="ml-2 text-gray-600 dark:text-gray-400"
                >{t("admin.loadingPosts")}</span
              >
            </div>
          </div>
          <!-- Pagination -->
          <div id="posts-pagination" class="mt-6 flex justify-center">
            <!-- Pagination will be added here -->
          </div>
        </div>
      </div>

      <!-- System Status -->
      <div
        class="bg-white dark:bg-slate-900 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700"
      >
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
            {t("admin.systemStatus")}
          </h3>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="flex items-center">
              <div
                id="api-status-icon"
                class="w-3 h-3 rounded-full bg-gray-400 mr-2"
              >
              </div>
              <span class="text-sm text-gray-600 dark:text-gray-400"
                >{t("admin.apiConnection")}:
              </span>
              <span id="api-status-text" class="text-sm font-medium ml-1"
                >{t("admin.checking")}</span
              >
            </div>
            <div class="flex items-center">
              <div
                id="auth-status-icon"
                class="w-3 h-3 rounded-full bg-green-500 mr-2"
              >
              </div>
              <span class="text-sm text-gray-600 dark:text-gray-400"
                >{t("admin.authentication")}:
              </span>
              <span
                id="auth-status-text"
                class="text-sm font-medium text-green-600 ml-1"
                >{t("admin.active")}</span
              >
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 rounded-full bg-blue-500 mr-2"></div>
              <span class="text-sm text-gray-600 dark:text-gray-400"
                >{t("admin.version")}:
              </span>
              <span class="text-sm font-medium text-blue-600 ml-1">v1.0.0</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- End of dashboard-content -->

    <!-- Access Denied Message (hidden by default) -->
    <div
      id="access-denied"
      class="hidden bg-red-100 dark:bg-red-900/20 border border-red-400 text-red-700 dark:text-red-400 px-6 py-4 rounded-lg text-center"
    >
      <h3 class="font-semibold text-lg mb-2">{t("admin.accessDenied")}</h3>
      <p class="mb-4">{t("admin.adminAccessRequired")}</p>
      <a
        href={`/${lang}/login`}
        class="inline-block px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200"
      >
        {t("admin.goToLogin")}
      </a>
    </div>
  </WidgetWrapper>
</Layout>

<script>
  import { initDashboardPage } from "~/scripts/auth/dashboardInit";

  // Initialize dashboard logic
  const lang = window.location.pathname.split("/")[1] || "en";

  // Use astro:page-load for View Transitions support, fallback to direct call
  document.addEventListener("astro:page-load", () => initDashboardPage(lang));
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () =>
      initDashboardPage(lang),
    );
  } else {
    initDashboardPage(lang);
  }
</script>
