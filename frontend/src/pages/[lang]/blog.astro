---
import { getCollection } from "astro:content";
import Layout from "~/layouts/PageLayout.astro";
import { useTranslations } from "~/i18n/utils";
import { languages } from "~/i18n";
import Grid from "~/components/blog/Grid.astro";

export async function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({
    params: { lang },
  }));
}

const { lang } = Astro.params;
const t = useTranslations(lang as keyof typeof languages);

// Fetch posts from Collection and filter by language
const allPosts = await getCollection("blog");
// Filtrujemy posty dla danego języka na podstawie ścieżki (en/xxx lub pl/xxx)
const langPosts = allPosts.filter((post) => post.id.startsWith(`${lang}/`));
const sortedPosts = langPosts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// Map to UI Post format
const blogPosts = sortedPosts.map((post) => {
  // Slug bez prefiksu języka
  const cleanSlug = post.data.slug || post.slug.replace(`${lang}/`, "");
  let image =
    post.data.heroImage ||
    post.data.featured_image ||
    "/assets/images/blog/default.png";
  return {
    id: cleanSlug,
    slug: cleanSlug,
    publishDate: post.data.pubDate,
    title: post.data.title,
    excerpt: post.data.description,
    image: image,
    permalink: `/${lang}/blog/${cleanSlug}`,
    author: "KGR33N",
    tags: post.data.tags || [],
    category: { slug: "general", title: "General" },
  };
});

const metadata = {
  title: t("blog.title"),
  description: t("blog.description"),
  robots: {
    index: true,
    follow: true,
  },
  openGraph: {
    type: "website",
    title: t("blog.title"),
    description: t("blog.subtitle"),
  },
};
---

<Layout metadata={metadata}>
  <section class="px-4 md:px-6 py-12 sm:py-16 lg:py-20 mx-auto max-w-7xl">
    <div class="text-center mb-12">
      <h1
        class="text-4xl md:text-5xl font-bold leading-tight mb-4 font-heading"
      >
        {t("blog.title")}
      </h1>
      <p class="text-xl text-muted max-w-3xl mx-auto">
        {t("blog.subtitle")}
      </p>
    </div>

    {
      blogPosts.length > 0 ? (
        <Grid posts={blogPosts} />
      ) : (
        <div class="text-center py-16">
          <div class="bg-blue-50 dark:bg-gray-800 rounded-lg p-8 max-w-2xl mx-auto">
            <div class="text-blue-600 dark:text-blue-400 mb-4">
              <svg
                class="w-16 h-16 mx-auto"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <h2 class="text-3xl font-bold text-default mb-4">
              {t("blog.comingSoon")}
            </h2>
            <p class="text-lg text-muted">{t("blog.noPostsMessage")}</p>
          </div>
        </div>
      )
    }
  </section>
</Layout>
