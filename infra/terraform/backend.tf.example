# =============================================================================
# TERRAFORM REMOTE STATE BACKEND (S3 + DynamoDB)
# =============================================================================
#
# This file configures Terraform to store state remotely in AWS S3.
#
# WHY REMOTE STATE?
# ─────────────────────────────────────────────────────────────────────────────
# 1. Collaboration: Multiple people can run Terraform (same state)
# 2. Security: State file contains secrets - S3 is encrypted
# 3. Backup: S3 has versioning - can recover previous states
# 4. Locking: DynamoDB prevents concurrent modifications
#
# SETUP INSTRUCTIONS:
# ─────────────────────────────────────────────────────────────────────────────
# Before using this, you need to create the S3 bucket and DynamoDB table:
#
# 1. Create S3 bucket (one-time, via AWS Console or CLI):
#    aws s3api create-bucket \
#      --bucket kgr33n-terraform-state \
#      --region eu-central-1 \
#      --create-bucket-configuration LocationConstraint=eu-central-1
#
# 2. Enable versioning:
#    aws s3api put-bucket-versioning \
#      --bucket kgr33n-terraform-state \
#      --versioning-configuration Status=Enabled
#
# 3. Enable encryption:
#    aws s3api put-bucket-encryption \
#      --bucket kgr33n-terraform-state \
#      --server-side-encryption-configuration \
#        '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'
#
# 4. Block public access:
#    aws s3api put-public-access-block \
#      --bucket kgr33n-terraform-state \
#      --public-access-block-configuration \
#        "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
#
# 5. Create DynamoDB table for locking:
#    aws dynamodb create-table \
#      --table-name kgr33n-terraform-locks \
#      --attribute-definitions AttributeName=LockID,AttributeType=S \
#      --key-schema AttributeName=LockID,KeyType=HASH \
#      --billing-mode PAY_PER_REQUEST \
#      --region eu-central-1
#
# 6. Then rename this file to backend.tf:
#    mv backend.tf.example backend.tf
#    terraform init -migrate-state
#
# =============================================================================

terraform {
  backend "s3" {
    # S3 bucket for state storage
    bucket = "kgr33n-terraform-state"
    key    = "prod/terraform.tfstate"
    region = "eu-central-1"
    
    # Enable encryption at rest
    encrypt = true
    
    # DynamoDB table for state locking
    dynamodb_table = "kgr33n-terraform-locks"
    
    # Optional: Use specific AWS profile
    # profile = "terraform"
  }
}

# =============================================================================
# NOTES
# =============================================================================
#
# State File Security:
# ────────────────────
# The state file contains sensitive information:
# - Resource IDs
# - IP addresses
# - Potentially secrets (if stored in resources)
#
# S3 provides:
# ✅ Encryption at rest (AES-256)
# ✅ Encryption in transit (HTTPS)
# ✅ Versioning (recovery)
# ✅ Access logging (audit)
# ✅ IAM-based access control
#
# Locking:
# ────────────────────
# DynamoDB table prevents concurrent state modifications.
# If two people run "terraform apply" simultaneously,
# one will wait for the other to finish.
#
# Cost:
# ────────────────────
# S3: ~$0.02/month (tiny file)
# DynamoDB: ~$0 with PAY_PER_REQUEST (very low usage)
#
# =============================================================================
