# =============================================================================
# NGINX INGRESS CONTROLLER - CUSTOM CONFIGURATION
# =============================================================================
#
# This ConfigMap customizes the Nginx Ingress Controller behavior.
# It is applied at the CLUSTER level, NOT the application level.
#
# IMPORTANT: This ConfigMap must be linked to the Ingress Controller during
# installation. Use one of these methods:
#
# Method 1: Helm install with custom config
#   helm install ingress-nginx ingress-nginx/ingress-nginx \
#     --namespace ingress-nginx \
#     --create-namespace \
#     --set controller.config.name=nginx-ingress-custom-config \
#     --set controller.config.namespace=kgr33n
#
# Method 2: Apply separately and reference in values.yaml
#   kubectl apply -f nginx-config.yaml
#   Then in Helm values: controller.config.use-existing: true
#
# This is different from frontend/nginx/nginx.conf which configures Nginx
# INSIDE the frontend container for serving static files.
#
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-ingress-custom-config
  namespace: ingress-nginx # Must be in the same namespace as the controller
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
data:
  # Custom Nginx snippets for the Ingress Controller
  # These are advanced configurations that show deep Nginx understanding

  # Gzip compression
  use-gzip: "true"
  gzip-level: "6"
  gzip-min-length: "1000"
  gzip-types: "application/javascript application/json application/xml text/css text/javascript text/plain text/xml image/svg+xml"

  # Proxy settings
  proxy-buffer-size: "16k"
  proxy-buffers: "4 16k"
  proxy-busy-buffers-size: "32k"

  # Connection settings
  keep-alive: "75"
  keep-alive-requests: "100"
  upstream-keepalive-connections: "32"

  # Logging
  log-format-upstream: '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" $request_length $request_time [$proxy_upstream_name] [$proxy_alternative_upstream_name] $upstream_addr $upstream_response_length $upstream_response_time $upstream_status $req_id'

  # Security
  ssl-protocols: "TLSv1.2 TLSv1.3"
  ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
  ssl-prefer-server-ciphers: "true"

  # Hide server info
  server-tokens: "false"
  hide-headers: "X-Powered-By,Server"
